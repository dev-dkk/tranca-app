{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 28, "column": 0}, "map": {"version":3,"sources":["file:///C:/Users/santo/OneDrive/%C3%81rea%20de%20Trabalho/Afrobraids%20Software/Aplica%C3%A7%C3%A3o/sistema-trancas/frontend/app/book/page.tsx"],"sourcesContent":["'use client';\r\n\r\nimport { useState, useEffect, Suspense } from 'react';\r\nimport { useRouter, useSearchParams } from 'next/navigation';\r\nimport Calendar from 'react-calendar';\r\nimport { format, addHours, isSameDay, parseISO, setHours, setMinutes } from 'date-fns';\r\nimport { ptBR } from 'date-fns/locale';\r\nimport '../calendar.css'; // Importa nosso CSS bonito\r\n\r\nfunction BookingContent() {\r\n  const router = useRouter();\r\n  const searchParams = useSearchParams();\r\n  const serviceId = searchParams.get('serviceId');\r\n\r\n  const [service, setService] = useState<any>(null);\r\n  const [user, setUser] = useState<any>(null);\r\n  const [selectedDate, setSelectedDate] = useState<Date>(new Date());\r\n  const [busySlots, setBusySlots] = useState<Date[]>([]);\r\n  const [selectedTime, setSelectedTime] = useState<string | null>(null);\r\n  const [loading, setLoading] = useState(false);\r\n\r\n  // Horários de funcionamento (Ex: 9h às 18h)\r\n  const timeSlots = [\"09:00\", \"10:00\", \"11:00\", \"13:00\", \"14:00\", \"15:00\", \"16:00\", \"17:00\", \"18:00\"];\r\n\r\n  useEffect(() => {\r\n    // 1. Verifica Login\r\n    const userStored = localStorage.getItem('user');\r\n    if (!userStored) {\r\n        alert(\"Você precisa estar logado para agendar!\");\r\n        router.push('/login');\r\n        return;\r\n    }\r\n    setUser(JSON.parse(userStored));\r\n\r\n    // 2. Busca Serviço\r\n    if (serviceId) {\r\n        fetch('http://localhost:3001/services').then(res => res.json()).then(data => {\r\n            const found = data.find((s: any) => s.id === serviceId);\r\n            setService(found);\r\n        });\r\n    }\r\n  }, [serviceId, router]);\r\n\r\n// 3. Busca horários ocupados (CÓDIGO SEGURO)\r\n  useEffect(() => {\r\n    // Só busca se tiver uma data selecionada\r\n    if (!selectedDate) return;\r\n\r\n    fetch(`http://localhost:3001/appointments/availability?date=${selectedDate.toISOString()}`)\r\n        .then(res => res.json())\r\n        .then((data) => {\r\n            // VERIFICAÇÃO DE SEGURANÇA:\r\n            // Só tenta rodar o .map se o que chegou for realmente uma Lista (Array)\r\n            if (Array.isArray(data)) {\r\n                const busy = data.map((app: any) => new Date(app.date));\r\n                setBusySlots(busy);\r\n            } else {\r\n                // Se não for array, é erro. Mostramos no console e limpamos os slots ocupados.\r\n                console.error(\"Erro ao buscar horários (Backend retornou erro):\", data);\r\n                setBusySlots([]); \r\n            }\r\n        })\r\n        .catch(err => {\r\n            console.error(\"Erro de conexão:\", err);\r\n            setBusySlots([]);\r\n        });\r\n  }, [selectedDate]);\r\n\r\n  const handleBooking = async () => {\r\n    if (!selectedTime || !service || !user) return;\r\n    setLoading(true);\r\n\r\n    // Monta a data final combinando o Dia escolhido + Hora escolhida\r\n    const [hora, minuto] = selectedTime.split(':').map(Number);\r\n    const finalDate = setMinutes(setHours(selectedDate, hora), minuto);\r\n\r\n    try {\r\n        const res = await fetch('http://localhost:3001/appointments', {\r\n            method: 'POST',\r\n            headers: { 'Content-Type': 'application/json' },\r\n            body: JSON.stringify({\r\n                userId: user.id,\r\n                serviceId: service.id,\r\n                date: finalDate.toISOString()\r\n            })\r\n        });\r\n\r\n        if (!res.ok) throw new Error(\"Erro ao agendar\");\r\n\r\n        alert(\"✅ Agendamento realizado com sucesso!\");\r\n        router.push('/profile'); // Manda pro perfil pra ver o agendamento\r\n\r\n    } catch (error) {\r\n        alert(\"Erro: Esse horário pode ter sido pego por outra pessoa agora pouco.\");\r\n    } finally {\r\n        setLoading(false);\r\n    }\r\n  };\r\n\r\n  // Função para verificar se um horário da lista está ocupado\r\n  const isSlotBusy = (time: string) => {\r\n    const [h, m] = time.split(':').map(Number);\r\n    // Cria uma data temporária com esse horário\r\n    const slotDate = setMinutes(setHours(selectedDate, h), m);\r\n    \r\n    // Verifica se existe algum agendamento no banco com a MESMA hora\r\n    return busySlots.some(busyDate => \r\n        busyDate.getHours() === slotDate.getHours() && \r\n        busyDate.getMinutes() === slotDate.getMinutes()\r\n    );\r\n  };\r\n\r\n  if (!service) return <div className=\"p-10 text-center\">Carregando serviço...</div>;\r\n\r\n  return (\r\n    <div className=\"min-h-screen bg-beleza-50 py-8 px-4 flex justify-center items-start\">\r\n        <div className=\"max-w-4xl w-full bg-white rounded-2xl shadow-xl overflow-hidden flex flex-col md:flex-row border border-beleza-100\">\r\n            \r\n            {/* Esquerda: Resumo do Serviço */}\r\n            <div className=\"bg-beleza-900 text-white p-8 md:w-1/3 flex flex-col\">\r\n                <h2 className=\"text-xl font-bold mb-4 opacity-80\">Você está agendando:</h2>\r\n                <h1 className=\"text-3xl font-bold mb-2 text-beleza-200\">{service.name}</h1>\r\n                <p className=\"text-sm opacity-70 mb-6\">{service.description}</p>\r\n                \r\n                <div className=\"mt-auto space-y-3\">\r\n                    <div className=\"flex justify-between border-b border-white/20 pb-2\">\r\n                        <span>Valor:</span>\r\n                        <span className=\"font-bold text-xl\">R$ {service.price}</span>\r\n                    </div>\r\n                    <div className=\"flex justify-between border-b border-white/20 pb-2\">\r\n                        <span>Duração:</span>\r\n                        <span className=\"font-bold\">{service.duration_minutes} min</span>\r\n                    </div>\r\n                </div>\r\n            </div>\r\n\r\n            {/* Direita: Calendário e Horários */}\r\n            <div className=\"p-6 md:w-2/3\">\r\n                <h3 className=\"text-lg font-bold text-beleza-900 mb-4\">1. Escolha a Data</h3>\r\n                \r\n                <Calendar \r\n                    onChange={(val) => { setSelectedDate(val as Date); setSelectedTime(null); }} \r\n                    value={selectedDate}\r\n                    locale=\"pt-BR\"\r\n                    minDate={new Date()} // Não deixa agendar no passado\r\n                    className=\"mb-8\"\r\n                />\r\n\r\n                <h3 className=\"text-lg font-bold text-beleza-900 mb-4\">2. Escolha o Horário</h3>\r\n                \r\n                <div className=\"grid grid-cols-3 sm:grid-cols-4 gap-3 mb-8\">\r\n                    {timeSlots.map(time => {\r\n                        const busy = isSlotBusy(time);\r\n                        return (\r\n                            <button\r\n                                key={time}\r\n                                disabled={busy}\r\n                                onClick={() => setSelectedTime(time)}\r\n                                className={`\r\n                                    py-2 px-4 rounded-lg text-sm font-bold border transition\r\n                                    ${busy \r\n                                        ? 'bg-gray-100 text-gray-300 border-gray-100 cursor-not-allowed decoration-slice' \r\n                                        : selectedTime === time\r\n                                            ? 'bg-beleza-500 text-white border-beleza-500 shadow-lg scale-105'\r\n                                            : 'bg-white text-beleza-700 border-beleza-200 hover:border-beleza-500 hover:bg-beleza-50'\r\n                                    }\r\n                                `}\r\n                            >\r\n                                {time}\r\n                            </button>\r\n                        )\r\n                    })}\r\n                </div>\r\n\r\n                <div className=\"flex justify-end\">\r\n                    <button \r\n                        onClick={handleBooking}\r\n                        disabled={!selectedTime || loading}\r\n                        className=\"bg-green-600 hover:bg-green-700 text-white font-bold py-3 px-8 rounded-lg transition disabled:opacity-50 disabled:cursor-not-allowed w-full md:w-auto\"\r\n                    >\r\n                        {loading ? 'Agendando...' : '✅ Confirmar Agendamento'}\r\n                    </button>\r\n                </div>\r\n            </div>\r\n        </div>\r\n    </div>\r\n  );\r\n}\r\n\r\nexport default function BookPage() {\r\n    return <Suspense fallback={<div>Carregando...</div>}><BookingContent /></Suspense>;\r\n}"],"names":[],"mappings":"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"}}]
}